{{- define "main" }}
<header class="page-header">
    <h1>{{ .Title }}</h1>
</header>

<div id="my-search-container">
    <input id="mySearchInput" autofocus 
           placeholder="{{ .Params.placeholder | default "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..." }}" 
           aria-label="search" type="search" autocomplete="off" 
           style="width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 1px solid var(--border); background: var(--entry); color: var(--primary);">
    <ul id="mySearchResults" style="list-style: none; padding: 0; margin-top: 20px;"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
window.addEventListener('load', () => {
    let fuse;
    let allResults = [];
    let currentDisplayCount = 10;
    let isLoading = false;
    let searchTimeout; // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨
    const input = document.getElementById('mySearchInput');
    const list = document.getElementById('mySearchResults');

    // ã‚»ãƒ³ãƒãƒãƒ«ã®ä½œæˆ
    const sentinel = document.createElement('div');
    sentinel.id = 'search-sentinel';
    sentinel.style.cssText = 'text-align:center; padding:20px; color:#666; font-size:14px; display:none;';
    list.parentNode.insertBefore(sentinel, list.nextSibling);

    // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    fetch('../index.json')
        .then(res => res.json())
        .then(data => {
            const cleanData = data.filter(item => item.title).sort((a, b) => {
                return new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/'));
            });
            // includeMatchesã‚’trueã«ã—ã¦ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å¯èƒ½ã«ã™ã‚‹
            fuse = new Fuse(cleanData, { 
                keys: ['title', 'summary'], 
                threshold: 0.4, 
                shouldSort: false,
                includeMatches: true 
            });

            // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯å¯¾ç­–ï¼šURLã‹ã‚‰æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
            const params = new URLSearchParams(window.location.search);
            const savedQuery = params.get('s');
            if (savedQuery) {
                input.value = savedQuery;
                performSearch(savedQuery, false);
            }
        });

    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆé–¢æ•°
    function highlight(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark style="background:none; color:#ffb300; font-weight:bold; padding:0;">$1</mark>');
    }

    // ã‚¢ã‚¤ãƒ†ãƒ æç”»
    function renderItem(result, query) {
        const item = result.item;
        return `
            <li style="position: relative; margin-bottom: 20px; padding: 15px; background: var(--entry); border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center;">
                ${item.image ? `<img src="${item.image}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; margin-right: 15px;">` : ''}
                <div>
                    <h3 style="margin: 0 0 5px 0; font-size: 1.1rem;">${highlight(item.title, query)}</h3>
                    <p style="margin: 0 0 5px 0; font-size: 0.75rem; color: var(--secondary); opacity: 0.8;">ğŸ“… ${item.date}</p>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--secondary);">${highlight(item.summary, query)}</p>
                </div>
                <a href="${item.permalink}" style="position: absolute; inset: 0; z-index: 1;"></a>
            </li>
        `;
    }

    // æ¤œç´¢å®Ÿè¡Œ
    function performSearch(query, updateUrl = true) {
        currentDisplayCount = 10;
        allResults = fuse.search(query);
        list.innerHTML = allResults.slice(0, 10).map(res => renderItem(res, query)).join('');
        
        sentinel.style.display = allResults.length > 10 ? 'block' : (allResults.length > 0 ? 'block' : 'none');
        sentinel.textContent = allResults.length > 10 ? 'èª­ã¿è¾¼ã¿ä¸­...' : (allResults.length > 0 ? 'ã™ã¹ã¦ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ' : 'ä¸€è‡´ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');

        if (updateUrl) {
            const newUrl = window.location.pathname + (query ? '?s=' + encodeURIComponent(query) : '');
            window.history.replaceState(null, '', newUrl);
        }
    }

    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
    input.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = input.value.trim();
        
        if (!query) {
            allResults = [];
            list.innerHTML = '';
            sentinel.style.display = 'none';
            window.history.replaceState(null, '', window.location.pathname);
            return;
        }

        // 250ms å…¥åŠ›ãŒæ­¢ã¾ã£ãŸã‚‰å®Ÿè¡Œ
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 250);
    });

    // ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç›£è¦–
    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && allResults.length > currentDisplayCount && !isLoading) {
            isLoading = true;
            const start = currentDisplayCount;
            currentDisplayCount += 10;
            const query = input.value.trim();
            const nextBatch = allResults.slice(start, currentDisplayCount);
            
            list.insertAdjacentHTML('beforeend', nextBatch.map(res => renderItem(res, query)).join(''));
            
            if (currentDisplayCount >= allResults.length) {
                sentinel.textContent = 'ã™ã¹ã¦ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ';
            }
            isLoading = false;
        }
    }, { rootMargin: '200px' });

    observer.observe(sentinel);
});
</script>
{{- end }}