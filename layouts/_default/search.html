{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyPrefix = 'hugo-scroll-' + window.location.pathname;
        const keyContent = keyPrefix + '-content';
        const keyPos = keyPrefix + '-pos';
        const keyPage = keyPrefix + '-page';

        // â–  1. ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè¨˜äº‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«ã€ãã®ç¬é–“ã®HTMLã‚’å…¨éƒ¨ä¿å­˜ï¼‰
        window.addEventListener('click', (e) => {
            if (e.target.closest('.post-entry')) {
                const postContainer = document.querySelector('.main');
                const nextLink = document.querySelector('.pagination .next a');
                
                // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å…¨è¨˜äº‹ã®HTMLã‚’ä¿å­˜
                sessionStorage.setItem(keyContent, postContainer.innerHTML);
                sessionStorage.setItem(keyPos, window.scrollY);
                
                // æ¬¡ã®ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ä¿å­˜ï¼ˆload-more.jsã¨ã®åŒæœŸç”¨ï¼‰
                if (nextLink) {
                    const match = nextLink.getAttribute('href').match(/page\/(\d+)/);
                    if (match) sessionStorage.setItem(keyPage, match[1]);
                }
            }
        });

        // â–  2. å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯
        const restore = () => {
            const savedContent = sessionStorage.getItem(keyContent);
            const savedPos = sessionStorage.getItem(keyPos);
            
            if (!savedContent || !savedPos) return;

            // ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒã‚’ç„¡åŠ¹åŒ–
            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            const postContainer = document.querySelector('.main');
            if (postContainer) {
                console.log("â™»ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰è¨˜äº‹ã‚’å¾©å…ƒä¸­...");
                // ä¿å­˜ã—ã¦ãŠã„ãŸHTMLã‚’ä¸€æ°—ã«æµã—è¾¼ã‚€ï¼ˆFetchä¸è¦ï¼ï¼‰
                postContainer.innerHTML = savedContent;

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
                setTimeout(() => {
                    window.scrollTo({ top: parseFloat(savedPos), behavior: 'instant' });
                    console.log("ğŸ“ ä½ç½®å¾©å…ƒå®Œäº†");
                }, 50);
            }
        };

        // â–  3. ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®åˆ¤å®š
        window.addEventListener('pageshow', (event) => {
            const nav = performance.getEntriesByType('navigation')[0];
            const isBackForward = (nav && nav.type === 'back_forward') || event.persisted;

            if (isBackForward) {
                restore();
            } else {
                // é€šå¸¸é·ç§»ï¼ˆãƒ­ã‚´ã‚¯ãƒªãƒƒã‚¯ç­‰ï¼‰ãªã‚‰å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
                sessionStorage.removeItem(keyContent);
                sessionStorage.removeItem(keyPos);
                sessionStorage.removeItem(keyPage);
            }
        });
    })();
</script>
{{- end -}}