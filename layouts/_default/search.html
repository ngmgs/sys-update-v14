{{- define "main" }}
<header class="page-header">
    <h1>{{ .Title }}</h1>
</header>

<div id="my-search-container">
    <input id="mySearchInput" autofocus 
           placeholder="{{ .Params.placeholder | default "æ¤œç´¢..." }}" 
           aria-label="search" type="search" autocomplete="off" 
           style="width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 1px solid var(--border); background: var(--entry); color: var(--primary);">
    
    <ul id="mySearchResults" style="list-style: none; padding: 0; margin-top: 20px;"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<script>
window.addEventListener('load', () => {
    let fuse;
    let allResults = [];      // æ¤œç´¢ã«ãƒ’ãƒƒãƒˆã—ãŸå…¨ãƒ‡ãƒ¼ã‚¿
    let currentDisplayCount = 10;
    let isLoading = false;    // äºŒé‡èª­ã¿è¾¼ã¿é˜²æ­¢ãƒ•ãƒ©ã‚°
    const input = document.getElementById('mySearchInput');
    const list = document.getElementById('mySearchResults');

    // 1. ã‚»ãƒ³ãƒãƒãƒ«ï¼ˆç›£è¦–ç”¨ãƒ‘ãƒ¼ãƒ„ï¼‰ã‚’ä½œæˆï¼ˆæ—¢å­˜ã®JSã¨åŒã˜ä½œã‚Šï¼‰
    const sentinel = document.createElement('div');
    sentinel.id = 'search-sentinel';
    sentinel.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    sentinel.style.cssText = 'text-align:center; padding:20px; color:#666; font-size:14px; display:none;';
    list.parentNode.insertBefore(sentinel, list.nextSibling);

    // 2. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    fetch('../index.json')
        .then(res => res.json())
        .then(data => {
            const cleanData = data.filter(item => item.title).sort((a, b) => {
                return new Date(b.date.replace(/-/g, '/')) - new Date(a.date.replace(/-/g, '/'));
            });
            fuse = new Fuse(cleanData, { keys: ['title', 'summary'], threshold: 0.4, shouldSort: false });
        });

    // 3. è¿½åŠ èª­ã¿è¾¼ã¿é–¢æ•°ï¼ˆæ—¢å­˜ã® loadNextPage ã«ç›¸å½“ï¼‰
    function loadMoreResults() {
        if (isLoading || allResults.length <= currentDisplayCount) return;
        
        isLoading = true;
        
        // å°‘ã—é–“ã‚’ç½®ã„ã¦ã€Œèª­ã¿è¾¼ã¿ä¸­ã€ã‚’ä½“é¨“ã•ã›ã‚‹ï¼ˆå¿…è¦ãªã‘ã‚Œã°ã™ãå®Ÿè¡Œã§ã‚‚OKï¼‰
        setTimeout(() => {
            const start = currentDisplayCount;
            currentDisplayCount += 10;
            const nextBatch = allResults.slice(start, currentDisplayCount);
            
            const newHtml = nextBatch.map(result => renderItem(result.item)).join('');
            list.insertAdjacentHTML('beforeend', newHtml);

            isLoading = false;
            if (currentDisplayCount >= allResults.length) {
                sentinel.textContent = 'ã™ã¹ã¦ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ';
            }
        }, 300);
    }

    // ã‚¢ã‚¤ãƒ†ãƒ 1ã¤åˆ†ã®HTMLä½œæˆï¼ˆã‚³ãƒ¼ãƒ‰ã‚’ç¶ºéº—ã«ã™ã‚‹ãŸã‚åˆ†é›¢ï¼‰
    function renderItem(item) {
        return `
            <li style="position: relative; margin-bottom: 20px; padding: 15px; background: var(--entry); border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center;">
                ${item.image ? `<img src="${item.image}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; margin-right: 15px;">` : ''}
                <div>
                    <h3 style="margin: 0 0 5px 0; font-size: 1.1rem;">${item.title}</h3>
                    <p style="margin: 0 0 5px 0; font-size: 0.75rem; color: var(--secondary); opacity: 0.8;">ğŸ“… ${item.date}</p>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--secondary);">${item.summary}</p>
                </div>
                <a href="${item.permalink}" style="position: absolute; inset: 0; z-index: 1;"></a>
            </li>
        `;
    }

    // 4. ç›£è¦–ï¼ˆIntersectionObserverï¼‰
    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && !isLoading) {
            loadMoreResults();
        }
    }, { rootMargin: '200px' });

    observer.observe(sentinel);

    // 5. æ¤œç´¢å…¥åŠ›
    input.addEventListener('input', () => {
        const query = input.value.trim();
        currentDisplayCount = 10;
        if (!query) {
            allResults = [];
            list.innerHTML = '';
            sentinel.style.display = 'none';
            return;
        }
        allResults = fuse.search(query);
        list.innerHTML = allResults.slice(0, 10).map(result => renderItem(result.item)).join('');
        
        sentinel.style.display = allResults.length > 10 ? 'block' : 'none';
        sentinel.textContent = allResults.length > 10 ? 'èª­ã¿è¾¼ã¿ä¸­...' : 'ã“ã‚Œä»¥ä¸Šçµæœã¯ã‚ã‚Šã¾ã›ã‚“';
    });
});
</script>
{{- end }}