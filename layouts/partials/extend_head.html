{{- if .IsNode -}}
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_HTML = 'infiniteScroll_html_' + location.pathname;
    const STORAGE_KEY_NEXT = 'infiniteScroll_next_' + location.pathname;
    
    console.log('[復元] スクリプト開始');
    
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedHTML = sessionStorage.getItem(STORAGE_KEY_HTML);
    const savedNextLink = sessionStorage.getItem(STORAGE_KEY_NEXT);
    
    if (savedScrollPos && savedHTML) {
        const savedSizeKB = (new Blob([savedHTML]).size / 1024).toFixed(2);
        console.log('[復元] 保存データあり');
        console.log('[復元] 保存されたHTML容量:', savedSizeKB, 'KB');
        console.log('[復元] 保存された次ページURL:', savedNextLink);
    }
    
    if (savedScrollPos && savedHTML && parseInt(savedScrollPos) > 0) {
        document.addEventListener('DOMContentLoaded', () => {
            const main = document.querySelector('.main');
            const pagination = document.querySelector('.pagination');
            
            if (main && pagination) {
                console.log('[復元] 復元前のnextLink:', pagination.querySelector('a.next')?.href);
                
                console.log('[復元] HTMLを復元します');
                main.innerHTML = savedHTML;
                
                console.log('[復元] 復元後のnextLink:', pagination.querySelector('a.next')?.href);
                
                // nextLinkを更新
                if (savedNextLink) {
                    const nextLink = pagination.querySelector('a.next');
                    if (nextLink) {
                        console.log('[復元] nextLinkを', nextLink.href, 'から', savedNextLink, 'に更新');
                        nextLink.href = savedNextLink;
                        console.log('[復元] 更新後:', pagination.querySelector('a.next')?.href);
                    } else {
                        console.log('[復元] nextLink要素が見つかりません');
                    }
                }
                
                console.log('[復元] スクロール位置へ移動:', savedScrollPos);
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedScrollPos));
                    sessionStorage.removeItem(STORAGE_KEY_SCROLL);
                    sessionStorage.removeItem(STORAGE_KEY_HTML);
                    sessionStorage.removeItem(STORAGE_KEY_NEXT);
                    console.log('[復元] 完了');
                }, 100);
            }
        });
    }
    
    function saveScrollState() {
        const scrollY = window.scrollY;
        const main = document.querySelector('.main');
        
        if (scrollY > 100 && main) {
            const htmlContent = main.innerHTML;
            const htmlSize = new Blob([htmlContent]).size;
            const htmlSizeKB = (htmlSize / 1024).toFixed(2);
            
            const nextLink = document.querySelector('.pagination a.next');
            const nextUrl = nextLink ? nextLink.href : null;
            
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            sessionStorage.setItem(STORAGE_KEY_HTML, htmlContent);
            if (nextUrl) {
                sessionStorage.setItem(STORAGE_KEY_NEXT, nextUrl);
            }
            
            let totalSize = 0;
            for (let key in sessionStorage) {
                if (sessionStorage.hasOwnProperty(key)) {
                    totalSize += sessionStorage[key].length + key.length;
                }
            }
            const totalSizeKB = (totalSize / 1024).toFixed(2);
            
            console.log('[保存] スクロール:', scrollY);
            console.log('[保存] 次ページ:', nextUrl);
            console.log('[保存] HTML容量:', htmlSizeKB, 'KB');
            console.log('[保存] sessionStorage全体:', totalSizeKB, 'KB / 約5120 KB');
        }
    }
    
    window.addEventListener('beforeunload', saveScrollState);
    window.addEventListener('pagehide', saveScrollState);
    window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            saveScrollState();
        }
    });
})();
</script>
{{- end -}}