{{- if .IsNode -}}
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_MAIN = 'infiniteScroll_main_' + location.pathname;
    const STORAGE_KEY_PAGINATION = 'infiniteScroll_pagination_' + location.pathname;
    
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedMain = sessionStorage.getItem(STORAGE_KEY_MAIN);
    const savedPagination = sessionStorage.getItem(STORAGE_KEY_PAGINATION);
    
    const isBackNavigation = performance.getEntriesByType('navigation')[0]?.type === 'back_forward';
    
    if (isBackNavigation && savedScrollPos && savedMain && parseInt(savedScrollPos) > 0) {
        document.addEventListener('DOMContentLoaded', () => {
            const main = document.querySelector('.main');
            const pagination = document.querySelector('.pagination');
            
            if (main) {
                main.innerHTML = savedMain;
                
                if (pagination && savedPagination) {
                    pagination.innerHTML = savedPagination;
                }
                
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedScrollPos));
                    sessionStorage.removeItem(STORAGE_KEY_SCROLL);
                    sessionStorage.removeItem(STORAGE_KEY_MAIN);
                    sessionStorage.removeItem(STORAGE_KEY_PAGINATION);
                }, 100);
            }
        });
    } else if (!isBackNavigation) {
        sessionStorage.removeItem(STORAGE_KEY_SCROLL);
        sessionStorage.removeItem(STORAGE_KEY_MAIN);
        sessionStorage.removeItem(STORAGE_KEY_PAGINATION);
    }
    
    function saveScrollState() {
        const scrollY = window.scrollY;
        const main = document.querySelector('.main');
        const pagination = document.querySelector('.pagination');
        
        if (scrollY > 100 && main) {
            const mainHTML = main.innerHTML;
            const paginationHTML = pagination ? pagination.innerHTML : '';
            
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            sessionStorage.setItem(STORAGE_KEY_MAIN, mainHTML);
            if (paginationHTML) {
                sessionStorage.setItem(STORAGE_KEY_PAGINATION, paginationHTML);
            }
        }
    }
    
    window.addEventListener('beforeunload', saveScrollState);
    window.addEventListener('pagehide', saveScrollState);
    window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            saveScrollState();
        }
    });
})();
</script>
{{- end -}}