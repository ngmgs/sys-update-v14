{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}"></script>
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_COUNT = 'infiniteScroll_count_' + location.pathname;
    
    console.log('[復元] スクリプト開始');
    
    function saveScrollState() {
        const scrollY = window.scrollY;
        const main = document.querySelector('.main');
        
        if (scrollY > 100 && main) {
            const postCount = main.querySelectorAll('.post-entry').length;
            
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            sessionStorage.setItem(STORAGE_KEY_COUNT, postCount);
            
            console.log('[保存成功] スクロール:', scrollY, '記事数:', postCount);
        }
    }
    
    window.addEventListener('beforeunload', saveScrollState);
    window.addEventListener('pagehide', saveScrollState);
    window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            saveScrollState();
        }
    });
    
    let saveInterval = setInterval(saveScrollState, 3000);

    // 復元処理
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedCount = sessionStorage.getItem(STORAGE_KEY_COUNT);
    
    console.log('[復元] 保存データ - スクロール:', savedScrollPos, '記事数:', savedCount);
    
    if (savedScrollPos && parseInt(savedScrollPos) > 0 && savedCount) {
        clearInterval(saveInterval);
        
        const waitForLoadMore = setInterval(() => {
            const main = document.querySelector('.main');
            const sentinel = document.querySelector('.infinite-scroll-sentinel');
            
            if (main && sentinel) {
                clearInterval(waitForLoadMore);
                
                const currentCount = main.querySelectorAll('.post-entry').length;
                const targetCount = parseInt(savedCount);
                
                console.log('[復元] 現在の記事数:', currentCount, '目標記事数:', targetCount);
                
                if (targetCount > currentCount) {
                    console.log('[復元] 記事を追加読み込みします');
                    restoreByCount(targetCount, parseInt(savedScrollPos));
                } else {
                    console.log('[復元] 追加読み込み不要、スクロールのみ');
                    scrollToPosition(parseInt(savedScrollPos));
                }
            }
        }, 100);
    }

    function restoreByCount(targetCount, targetScroll) {
        const main = document.querySelector('.main');
        const pagination = document.querySelector('.pagination');
        const currentNextLink = pagination ? pagination.querySelector('a.next') : null;
        
        const currentCount = main.querySelectorAll('.post-entry').length;
        
        console.log('[復元] 現在:', currentCount, '記事 / 目標:', targetCount, '記事');
        
        if (!main || !currentNextLink) {
            console.log('[復元] これ以上読み込めません');
            scrollToPosition(targetScroll);
            return;
        }
        
        if (currentCount < targetCount) {
            const nextUrl = currentNextLink.href;
            console.log('[復元] 次ページ読み込み:', nextUrl);
            
            fetch(nextUrl)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newPosts = doc.querySelectorAll('.post-entry');
                    console.log('[復元] 追加記事数:', newPosts.length);
                    
                    newPosts.forEach(post => main.appendChild(post));
                    
                    const newNextLink = doc.querySelector('.pagination a.next');
                    if (newNextLink && currentNextLink) {
                        currentNextLink.href = newNextLink.href;
                    }
                    
                    const updatedCount = main.querySelectorAll('.post-entry').length;
                    console.log('[復元] 読み込み後の記事数:', updatedCount);
                    
                    if (updatedCount < targetCount && newNextLink) {
                        // まだ足りない場合は続けて読み込む
                        setTimeout(() => restoreByCount(targetCount, targetScroll), 100);
                    } else {
                        console.log('[復元] 目標記事数到達');
                        scrollToPosition(targetScroll);
                    }
                })
                .catch(err => {
                    console.error('[復元] エラー:', err);
                    scrollToPosition(targetScroll);
                });
        } else {
            console.log('[復元] 既に目標記事数に到達');
            scrollToPosition(targetScroll);
        }
    }

    function scrollToPosition(pos) {
        console.log('[復元] スクロール位置へ移動:', pos);
        setTimeout(() => {
            window.scrollTo(0, pos);
            sessionStorage.removeItem(STORAGE_KEY_SCROLL);
            sessionStorage.removeItem(STORAGE_KEY_COUNT);
            console.log('[復元] 完了');
            saveInterval = setInterval(saveScrollState, 3000);
        }, 300);
    }
})();
</script>
{{- end -}}