{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}"></script>
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_HTML = 'infiniteScroll_html_' + location.pathname;
    
    console.log('[復元] スクリプト開始');
    
    function saveScrollState() {
        const scrollY = window.scrollY;
        const main = document.querySelector('.main');
        
        if (scrollY > 100 && main) {
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            sessionStorage.setItem(STORAGE_KEY_HTML, main.innerHTML);
            
            console.log('[保存] スクロール:', scrollY, 'HTML保存完了');
        }
    }
    
    window.addEventListener('beforeunload', saveScrollState);
    window.addEventListener('pagehide', saveScrollState);
    window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            saveScrollState();
        }
    });

    // 復元処理
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedHTML = sessionStorage.getItem(STORAGE_KEY_HTML);
    
    console.log('[復元] 保存データあり:', !!savedScrollPos, !!savedHTML);
    
    if (savedScrollPos && savedHTML && parseInt(savedScrollPos) > 0) {
        const main = document.querySelector('.main');
        
        if (main) {
            console.log('[復元] HTMLを復元します');
            main.innerHTML = savedHTML;
            
            console.log('[復元] スクロール位置へ移動:', savedScrollPos);
            setTimeout(() => {
                window.scrollTo(0, parseInt(savedScrollPos));
                sessionStorage.removeItem(STORAGE_KEY_SCROLL);
                sessionStorage.removeItem(STORAGE_KEY_HTML);
                console.log('[復元] 完了');
            }, 100);
        }
    }
})();
</script>
{{- end -}}