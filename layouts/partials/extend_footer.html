{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}"></script>
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_LOADED = 'infiniteScroll_loaded_' + location.pathname;
    
    console.log('[復元] スクリプト開始');
    
    function saveScrollState() {
        const scrollY = window.scrollY;
        const nextLink = document.querySelector('.pagination a.next');
        
        if (scrollY > 100) {
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            
            // 読み込み済みの最大ページ番号を計算
            // 次が page/2 なら、現在 page/1 まで表示済み
            // 次が page/3 なら、現在 page/2 まで表示済み
            const currentPage = getCurrentPageNumber();
            let loadedUpTo = currentPage;
            
            // 記事コンテナ内の全記事数から推測する方法もあるが、
            // nextLinkから逆算する方が確実
            if (nextLink) {
                const nextPageNum = getPageNumber(nextLink.href);
                loadedUpTo = nextPageNum - 1; // 次が2なら、1まで読み込み済み
            }
            
            sessionStorage.setItem(STORAGE_KEY_LOADED, loadedUpTo);
            console.log('[保存成功] スクロール:', scrollY, '読み込み済み:', loadedUpTo, '次:', nextLink ? nextLink.href : 'なし');
        }
    }
    
    function getCurrentPageNumber() {
        const match = location.pathname.match(/\/page\/(\d+)/);
        return match ? parseInt(match[1]) : 1;
    }
    
    function getPageNumber(url) {
        const match = url.match(/\/page\/(\d+)/);
        return match ? parseInt(match[1]) : 2; // デフォルトは2（トップページの次）
    }
    
    window.addEventListener('beforeunload', saveScrollState);
    window.addEventListener('pagehide', saveScrollState);
    window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            saveScrollState();
        }
    });
    
    let saveInterval = setInterval(saveScrollState, 3000);

    // 復元処理
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedLoadedPage = sessionStorage.getItem(STORAGE_KEY_LOADED);
    
    console.log('[復元] 保存データ - スクロール:', savedScrollPos, '読み込み済みページ:', savedLoadedPage);
    
    if (savedScrollPos && parseInt(savedScrollPos) > 0 && savedLoadedPage) {
        const currentPage = getCurrentPageNumber();
        const targetPage = parseInt(savedLoadedPage);
        
        console.log('[復元] 現在ページ:', currentPage, '目標ページ:', targetPage);
        
        if (targetPage > currentPage) {
            console.log('[復元] ページ', currentPage, 'から', targetPage, 'まで読み込みが必要');
            clearInterval(saveInterval);
            
            const waitForLoadMore = setInterval(() => {
                const main = document.querySelector('.main');
                const sentinel = document.querySelector('.infinite-scroll-sentinel');
                
                if (main && sentinel) {
                    clearInterval(waitForLoadMore);
                    console.log('[復元] 準備完了、復元開始');
                    restorePages(currentPage, targetPage, parseInt(savedScrollPos));
                }
            }, 100);
        } else {
            console.log('[復元] 追加読み込み不要、スクロールのみ');
            setTimeout(() => scrollToPosition(parseInt(savedScrollPos)), 500);
        }
    }

    function restorePages(currentPage, targetPage, targetScroll) {
        const main = document.querySelector('.main');
        const pagination = document.querySelector('.pagination');
        const currentNextLink = pagination ? pagination.querySelector('a.next') : null;
        
        console.log('[復元] restorePages - 現在:', currentPage, '目標:', targetPage);
        
        if (!main || !currentNextLink) {
            console.log('[復元] 要素なし、スクロールへ');
            scrollToPosition(targetScroll);
            return;
        }
        
        if (currentPage < targetPage) {
            const nextUrl = currentNextLink.href;
            console.log('[復元] 読み込み中:', nextUrl);
            
            fetch(nextUrl)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newPosts = doc.querySelectorAll('.post-entry');
                    console.log('[復元] 追加記事数:', newPosts.length);
                    
                    newPosts.forEach(post => main.appendChild(post));
                    
                    const newNextLink = doc.querySelector('.pagination a.next');
                    if (newNextLink && currentNextLink) {
                        currentNextLink.href = newNextLink.href;
                    }
                    
                    const loadedPage = currentPage + 1;
                    console.log('[復元] ページ', loadedPage, '読み込み完了');
                    
                    if (loadedPage < targetPage) {
                        setTimeout(() => restorePages(loadedPage, targetPage, targetScroll), 100);
                    } else {
                        console.log('[復元] 全ページ読み込み完了');
                        scrollToPosition(targetScroll);
                    }
                })
                .catch(err => {
                    console.error('[復元] エラー:', err);
                    scrollToPosition(targetScroll);
                });
        } else {
            scrollToPosition(targetScroll);
        }
    }

    function scrollToPosition(pos) {
        console.log('[復元] スクロール位置へ移動:', pos);
        setTimeout(() => {
            window.scrollTo(0, pos);
            sessionStorage.removeItem(STORAGE_KEY_SCROLL);
            sessionStorage.removeItem(STORAGE_KEY_LOADED);
            console.log('[復元] 完了、sessionStorage削除');
            saveInterval = setInterval(saveScrollState, 3000);
        }, 300);
    }
})();
</script>
{{- end -}}