{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyItemIdx = 'item-idx-' + window.location.pathname;
        const ITEMS_PER_PAGE = 10; // ã“ã“ã‚’å®Ÿéš›ã®1ãƒšãƒ¼ã‚¸ä»¶æ•°ã«åˆã‚ã›ã¦ãã ã•ã„

        // ä¿å­˜å‡¦ç†
        window.addEventListener('click', (e) => {
            const entry = e.target.closest('.post-entry');
            if (entry) {
                const allEntries = Array.from(document.querySelectorAll('.post-entry'));
                sessionStorage.setItem(keyItemIdx, allEntries.indexOf(entry));
                sessionStorage.setItem(keyScroll, window.scrollY);
            }
        });

        const restore = async () => {
            const savedIdx = parseInt(sessionStorage.getItem(keyItemIdx));
            const savedScroll = sessionStorage.getItem(keyScroll);
            if (isNaN(savedIdx)) return;

            const neededPages = Math.floor(savedIdx / ITEMS_PER_PAGE) + 1;
            if (neededPages <= 1) return; // 1ãƒšãƒ¼ã‚¸ç›®ãªã‚‰ä½•ã‚‚ã—ãªã„

            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            const postContainer = document.querySelector('.main');
            const parser = new DOMParser();

            console.log(`ðŸ›  å¾©å…ƒä¸­... ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${savedIdx}ç•ªç›® (è¨ˆ${neededPages}ãƒšãƒ¼ã‚¸)`);

            // è³¢ã„ãƒã‚¤ãƒ³ãƒˆï¼š2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã€Œã ã‘ã€ã‚’é †ç•ªã«å–ã£ã¦ãã¦å¾Œã‚ã«ç¹‹ã’ã‚‹
            // 1ãƒšãƒ¼ã‚¸ç›®ã¯æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ fetch ã—ãªã„ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
            for (let i = 2; i <= neededPages; i++) {
                try {
                    const res = await fetch(`${window.location.pathname}page/${i}/`);
                    if (!res.ok) break;
                    
                    const html = await res.text();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newPosts = doc.querySelectorAll('.post-entry');
                    
                    // æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ãªãŒã‚‰çµåˆ
                    newPosts.forEach(p => {
                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜ãƒªãƒ³ã‚¯ã®è¨˜äº‹ãŒã‚ã‚Œã°é£›ã°ã™ï¼‰
                        const link = p.querySelector('a')?.href;
                        if (link && !postContainer.querySelector(`a[href="${link}"]`)) {
                            postContainer.appendChild(p);
                        }
                    });

                    // Paginationã®æ›´æ–°ï¼ˆload-more.jsã®ç¶šãã®ãŸã‚ï¼‰
                    const newPagination = doc.querySelector('.pagination');
                    if (newPagination) {
                        const currentPagination = document.querySelector('.pagination');
                        if (currentPagination) currentPagination.innerHTML = newPagination.innerHTML;
                    }
                    console.log(`âœ… page/${i} ã‚’çµåˆã—ã¾ã—ãŸ`);
                } catch (err) { break; }
            }

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
            setTimeout(() => {
                window.scrollTo({ top: parseFloat(savedScroll), behavior: 'instant' });
            }, 100);
        };

        window.addEventListener('pageshow', (e) => {
            const isBack = e.persisted || performance.getEntriesByType('navigation')[0]?.type === 'back_forward';
            if (isBack) restore();
            else {
                sessionStorage.removeItem(keyItemIdx);
                sessionStorage.removeItem(keyScroll);
            }
        });
    })();
</script>
{{- end -}}