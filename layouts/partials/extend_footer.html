{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}"></script>
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_NEXT = 'infiniteScroll_next_' + location.pathname;
    
    console.log('[復元] スクリプト開始');
    
    // 保存関数
    function saveScrollState() {
        const scrollY = window.scrollY;
        const nextLink = document.querySelector('.pagination a.next');
        
        console.log('[保存試行] スクロール:', scrollY, '次ページ:', nextLink ? nextLink.href : 'なし');
        
        if (scrollY > 100) {  // 少しスクロールしている場合のみ
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            if (nextLink) {
                sessionStorage.setItem(STORAGE_KEY_NEXT, nextLink.href);
            }
            console.log('[保存成功] sessionStorageに保存しました');
        }
    }
    
    // 複数のイベントで保存を試みる
    window.addEventListener('beforeunload', saveScrollState);
    window.addEventListener('pagehide', saveScrollState);
    window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            saveScrollState();
        }
    });
    
    // 定期的に保存（念のため）
    let saveInterval = setInterval(saveScrollState, 2000);

    // 復元処理
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedNextLink = sessionStorage.getItem(STORAGE_KEY_NEXT);
    
    console.log('[復元] 保存されたスクロール:', savedScrollPos);
    console.log('[復元] 保存された次ページ:', savedNextLink);
    
    if (savedScrollPos && parseInt(savedScrollPos) > 0 && savedNextLink) {
        console.log('[復元] 復元開始');
        clearInterval(saveInterval); // 復元中は定期保存停止
        
        const waitForLoadMore = setInterval(() => {
            const main = document.querySelector('.main');
            const sentinel = document.querySelector('.infinite-scroll-sentinel');
            
            if (main && sentinel) {
                clearInterval(waitForLoadMore);
                console.log('[復元] load-more.js準備完了');
                restoreState(savedNextLink, parseInt(savedScrollPos));
            }
        }, 100);
    }

    function restoreState(targetUrl, targetScroll) {
        console.log('[復元] restoreState呼び出し、目標:', targetUrl);
        const main = document.querySelector('.main');
        const pagination = document.querySelector('.pagination');
        let currentNextLink = pagination ? pagination.querySelector('a.next') : null;
        
        console.log('[復元] 現在nextLink:', currentNextLink ? currentNextLink.href : 'なし');
        
        if (!main || !currentNextLink) {
            console.log('[復元] 要素なし、スクロールのみ実行');
            scrollToPosition(targetScroll);
            return;
        }

        if (currentNextLink.href !== targetUrl) {
            console.log('[復元] ページ読み込み開始:', currentNextLink.href);
            
            fetch(currentNextLink.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newPosts = doc.querySelectorAll('.post-entry');
                    console.log('[復元] 追加記事数:', newPosts.length);
                    
                    newPosts.forEach(post => main.appendChild(post));
                    
                    const newNextLink = doc.querySelector('.pagination a.next');
                    if (newNextLink && currentNextLink) {
                        currentNextLink.href = newNextLink.href;
                        console.log('[復元] nextLink更新:', newNextLink.href);
                        setTimeout(() => restoreState(targetUrl, targetScroll), 100);
                    } else {
                        console.log('[復元] 最終ページ到達');
                        scrollToPosition(targetScroll);
                    }
                })
                .catch(err => {
                    console.error('[復元] fetch失敗:', err);
                    scrollToPosition(targetScroll);
                });
        } else {
            console.log('[復元] 目標URL到達、スクロール実行');
            scrollToPosition(targetScroll);
        }
    }

    function scrollToPosition(pos) {
        console.log('[復元] スクロール位置設定:', pos);
        setTimeout(() => {
            window.scrollTo(0, pos);
            sessionStorage.removeItem(STORAGE_KEY_SCROLL);
            sessionStorage.removeItem(STORAGE_KEY_NEXT);
            console.log('[復元] 完了');
            // 復元完了後、定期保存再開
            saveInterval = setInterval(saveScrollState, 2000);
        }, 300);
    }
})();
</script>
{{- end -}}