{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyItemIdx = 'item-idx-' + window.location.pathname;

        // â–  1. ä¿å­˜å‡¦ç†ï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ­ã‚°ã‚’å‡ºã™ï¼‰
        window.addEventListener('click', (e) => {
            const entry = e.target.closest('.post-entry');
            if (entry) {
                const allEntries = Array.from(document.querySelectorAll('.post-entry'));
                const idx = allEntries.indexOf(entry);
                
                // --- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° ---
                console.log("-----------------------------------");
                console.log("ğŸ“ è¨˜äº‹ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
                console.log("è¨˜äº‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:", idx, "(ä¸Šã‹ã‚‰ä½•ç•ªç›®ã‹ã€‚0ã‹ã‚‰é–‹å§‹)");
                console.log("å¿…è¦ã¨æ¨æ¸¬ã•ã‚Œã‚‹ãƒšãƒ¼ã‚¸æ•°:", Math.floor(idx / 10) + 1);
                console.log("ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®:", window.scrollY);
                console.log("-----------------------------------");
                
                sessionStorage.setItem(keyItemIdx, idx);
                sessionStorage.setItem(keyScroll, window.scrollY);
            }
        });

        // â–  2. å¾©å…ƒå‡¦ç†
        const restore = async () => {
            const savedIdx = parseInt(sessionStorage.getItem(keyItemIdx));
            const savedScroll = sessionStorage.getItem(keyScroll);
            
            if (isNaN(savedIdx)) {
                console.log("â„¹ï¸ å¾©å…ƒç”¨ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ä½•ã‚‚ã—ã¾ã›ã‚“ã€‚");
                return;
            }

            console.log("ğŸ”„ ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯å¾©å…ƒã‚’é–‹å§‹ã—ã¾ã™ã€‚ç›®æ¨™ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:", savedIdx);

            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            const neededPages = Math.floor(savedIdx / 10) + 1;
            
            if (neededPages > 1) {
                const postContainer = document.querySelector('.main');
                const parser = new DOMParser();
                const requests = [];

                for (let i = 2; i <= neededPages; i++) {
                    requests.push(fetch(`${window.location.pathname}page/${i}/`).then(r => r.text()));
                }

                console.log(`ğŸš€ ${neededPages}ãƒšãƒ¼ã‚¸åˆ†ã‚’ä¸¦åˆ—ãƒ­ãƒ¼ãƒ‰ä¸­...`);
                try {
                    const htmls = await Promise.all(requests);
                    htmls.forEach((html, i) => {
                        const doc = parser.parseFromString(html, 'text/html');
                        const newPosts = doc.querySelectorAll('.post-entry');
                        newPosts.forEach(p => postContainer.appendChild(p));
                        console.log(`âœ… page/${i + 2} ã®è¿½åŠ å®Œäº†ï¼ˆè¨˜äº‹æ•°: ${newPosts.length}ï¼‰`);
                        
                        const newPagination = doc.querySelector('.pagination');
                        if (newPagination) {
                            document.querySelector('.pagination').innerHTML = newPagination.innerHTML;
                        }
                    });
                } catch (err) {
                    console.error("âŒ å¾©å…ƒãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:", err);
                }
            }

            setTimeout(() => {
                window.scrollTo({ top: parseFloat(savedScroll), behavior: 'instant' });
                console.log("ğŸ“ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒå®Œäº†ï¼ ä½ç½®:", savedScroll);
            }, 150);
        };

        window.addEventListener('pageshow', (e) => {
            const nav = performance.getEntriesByType('navigation')[0];
            const isBackForward = (nav && nav.type === 'back_forward') || e.persisted;

            if (isBackForward) {
                restore();
            } else {
                // é€šå¸¸é·ç§»æ™‚ã¯ãƒ­ã‚°ã‚’å‡ºã—ã¦æ¶ˆå»
                if (sessionStorage.getItem(keyItemIdx)) {
                    console.log("ğŸ§¹ é€šå¸¸é·ç§»ã‚’æ¤œçŸ¥ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç ´æ£„ã—ã¾ã—ãŸã€‚");
                    sessionStorage.removeItem(keyItemIdx);
                    sessionStorage.removeItem(keyScroll);
                }
            }
        });
    })();
</script>
{{- end -}}