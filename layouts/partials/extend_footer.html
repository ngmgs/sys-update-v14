{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyPage   = 'scroll-page-' + window.location.pathname;

        // â–  1. çŠ¶æ…‹ã®ä¿å­˜ï¼ˆãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ï¼‰
        // ç¾åœ¨ã€Œä½•ãƒšãƒ¼ã‚¸ç›®ã¾ã§èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã‹ã€ã‚’ã€æ¬¡ã¸ãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯ã‹ã‚‰æ¨æ¸¬ã—ã¦ä¿å­˜ã—ã¾ã™
        window.addEventListener('beforeunload', () => {
            const nextLink = document.querySelector('.pagination .next a');
            let currentPage = 1;
            
            if (nextLink) {
                // æ¬¡ã®ãƒªãƒ³ã‚¯ãŒ /page/5/ ãªã‚‰ã€ç¾åœ¨ã¯ 4ãƒšãƒ¼ã‚¸ç›®ã¾ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨åˆ¤æ–­
                const match = nextLink.getAttribute('href').match(/page\/(\d+)/);
                if (match) {
                    currentPage = parseInt(match[1]) - 1;
                }
            } else {
                // æ¬¡ã¸ãƒœã‚¿ãƒ³ãŒãªã„ï¼æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¾ã§èª­ã¿è¾¼ã‚“ã§ã„ã‚‹å ´åˆ
                // DOMã®è¨˜äº‹æ•°ã‚’æ•°ãˆã‚‹ãªã©ç°¡æ˜“çš„ãªåˆ¤å®šã€ã‚‚ã—ãã¯ã€Œååˆ†å¤§ãã„æ•°ã€ã¨ã—ã¦æ‰±ã†
                const entries = document.querySelectorAll('.post-entry'); // PaperModã®è¨˜äº‹ã‚¯ãƒ©ã‚¹
                if(entries.length > 10) currentPage = Math.ceil(entries.length / 10); // 1ãƒšãƒ¼ã‚¸10ä»¶ã¨ä»®å®š
            }

            if (window.scrollY > 100) {
                sessionStorage.setItem(keyScroll, window.scrollY);
                sessionStorage.setItem(keyPage, currentPage);
            }
        });

        // â–  2. çŠ¶æ…‹ã®å¾©å…ƒï¼ˆæˆ»ã£ã¦ããŸæ™‚ï¼‰
        window.addEventListener('DOMContentLoaded', async () => {
            const savedScroll = sessionStorage.getItem(keyScroll);
            const savedPage   = parseInt(sessionStorage.getItem(keyPage) || "1");

            if (!savedScroll || savedPage <= 1) return;

            // ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®å¾©å…ƒã‚’åœæ­¢
            if ('scrollRestoration' in history) {
                history.scrollRestoration = 'manual';
            }

            // â˜…ã“ã“ãŒ search.html ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§ã™â˜…
            // å¿…è¦ãªãƒšãƒ¼ã‚¸æ•°ã¾ã§ã€è£å´ã§ä¸€æ°—ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã¦çµåˆã—ã¾ã™
            console.log(`â™»ï¸ å¾©å…ƒé–‹å§‹: ${savedPage}ãƒšãƒ¼ã‚¸ç›®ã¾ã§ä¸€æ‹¬èª­ã¿è¾¼ã¿ä¸­...`);
            
            const postContainer = document.querySelector('.main'); // è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹è¦ªè¦ç´ 
            const parser = new DOMParser();

            // 2ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒšãƒ¼ã‚¸æ•°ã¾ã§é †ç•ªã«Fetch
            for (let i = 2; i <= savedPage; i++) {
                try {
                    const url = `${window.location.pathname}page/${i}/`;
                    const response = await fetch(url);
                    const html = await response.text();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // è¨˜äº‹éƒ¨åˆ†ã‚’å–å¾—ã—ã¦ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
                    const newPosts = doc.querySelectorAll('.post-entry'); // PaperModã®è¨˜äº‹ã‚¯ãƒ©ã‚¹
                    newPosts.forEach(post => {
                        postContainer.appendChild(post);
                    });

                    // ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯ã‚‚æ›´æ–°ï¼ˆload-more.js ãŒãƒã‚°ã‚‰ãªã„ã‚ˆã†ã«ï¼‰
                    const currentPagination = document.querySelector('.pagination');
                    const newPagination = doc.querySelector('.pagination');
                    if (currentPagination && newPagination) {
                        currentPagination.innerHTML = newPagination.innerHTML;
                    }

                } catch (e) {
                    console.error("å¾©å…ƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                    break; 
                }
            }

            // èª­ã¿è¾¼ã¿çµ‚ã‚ã£ãŸã‚‰ã€ä¸€ç¬ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
            // ç”»åƒã®èª­ã¿è¾¼ã¿ã‚ºãƒ¬ã‚’é˜²ããŸã‚ã€ã‚ãšã‹ã«å¾…æ©Ÿ
            setTimeout(() => {
                window.scrollTo({
                    top: parseFloat(savedScroll),
                    behavior: 'instant'
                });
                console.log("ğŸ“ ä½ç½®å¾©å…ƒå®Œäº†");
            }, 100);
        });
    })();
</script>
{{- end -}}