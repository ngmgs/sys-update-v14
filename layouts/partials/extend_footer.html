{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyItemIdx = 'item-idx-' + window.location.pathname;
        const ITEMS_PER_PAGE = 10; // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°

        // 1. ä¿å­˜ï¼šã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¨˜äº‹ã®ç•ªå·ã¨ä½ç½®ã‚’è¨˜éŒ²
        window.addEventListener('click', (e) => {
            const entry = e.target.closest('.post-entry');
            if (entry) {
                const allEntries = Array.from(document.querySelectorAll('.post-entry'));
                sessionStorage.setItem(keyItemIdx, allEntries.indexOf(entry));
                sessionStorage.setItem(keyScroll, window.scrollY);
            }
        });

        // 2. å¾©å…ƒãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
        const restore = async () => {
            const savedIdx = parseInt(sessionStorage.getItem(keyItemIdx));
            const savedScroll = sessionStorage.getItem(keyScroll);
            if (isNaN(savedIdx) || !savedScroll) return;

            const neededPages = Math.floor(savedIdx / ITEMS_PER_PAGE) + 1;
            if (neededPages <= 1) return; // 1ãƒšãƒ¼ã‚¸ç›®ãªã‚‰æ¨™æº–æ©Ÿèƒ½ã«ä»»ã›ã‚‹

            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            const postContainer = document.querySelector('.main');
            if (!postContainer) return;

            // â˜… ã‚€ã¡ã‚ƒãã¡ã‚ƒã«ãªã‚‰ãªã„ãŸã‚ã®ãƒã‚¤ãƒ³ãƒˆ
            // ä¸€æ—¦ã€ä¸­èº«ï¼ˆ1ãƒšãƒ¼ã‚¸ç›®ã®å†…å®¹ãªã©ï¼‰ã‚’å…¨éƒ¨æ¶ˆã—ã¦ã€ŒçœŸã£ç™½ã€ã«ã™ã‚‹
            postContainer.innerHTML = '';
            
            const parser = new DOMParser();
            console.log(`ğŸ›  1ãƒšãƒ¼ã‚¸ã‹ã‚‰${neededPages}ãƒšãƒ¼ã‚¸ã¾ã§ã‚’é †ç•ªã«å†æ§‹ç¯‰ä¸­...`);

            // 1ãƒšãƒ¼ã‚¸ç›®ã‹ã‚‰å¿…è¦ãªãƒšãƒ¼ã‚¸ã¾ã§é †ç•ªã«å–å¾—ã—ã¦è¿½åŠ ã—ã¦ã„ã
            for (let i = 1; i <= neededPages; i++) {
                try {
                    const url = i === 1 ? window.location.pathname : `${window.location.pathname}page/${i}/`;
                    const res = await fetch(url);
                    if (!res.ok) break;
                    
                    const html = await res.text();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newPosts = doc.querySelectorAll('.post-entry');
                    
                    newPosts.forEach(p => postContainer.appendChild(p.cloneNode(true)));

                    // Paginationï¼ˆæ¬¡ã¸ãƒœã‚¿ãƒ³ï¼‰ã‚’æœ€æ–°ãƒšãƒ¼ã‚¸ã®ã‚‚ã®ã«æ›´æ–°
                    const newPagination = doc.querySelector('.pagination');
                    if (newPagination) {
                        const currentPagination = document.querySelector('.pagination');
                        if (currentPagination) currentPagination.innerHTML = newPagination.innerHTML;
                    }
                } catch (err) {
                    console.error("ãƒšãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
                    break;
                }
            }

            // 3. å…¨ã¦ã®çµåˆãŒçµ‚ã‚ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                window.scrollTo({ top: parseFloat(savedScroll), behavior: 'instant' });
                console.log("ğŸ“ å¾©å…ƒå®Œäº†");
            }, 100);
        };

        // 4. å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åˆ¶å¾¡
        window.addEventListener('pageshow', (e) => {
            const isBack = e.persisted || performance.getEntriesByType('navigation')[0]?.type === 'back_forward';
            if (isBack) {
                restore();
            } else {
                // é€šå¸¸é·ç§»æ™‚ã¯å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                sessionStorage.removeItem(keyItemIdx);
                sessionStorage.removeItem(keyScroll);
            }
        });
    })();
</script>
{{- end -}}