{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}"></script>
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_NEXT = 'infiniteScroll_next_' + location.pathname;
    const STORAGE_KEY_LOADED = 'infiniteScroll_loaded_' + location.pathname;
    
    console.log('[復元] スクリプト開始');
    
    function saveScrollState() {
        const scrollY = window.scrollY;
        const nextLink = document.querySelector('.pagination a.next');
        
        if (scrollY > 100) {
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            if (nextLink) {
                sessionStorage.setItem(STORAGE_KEY_NEXT, nextLink.href);
            }
            
            // 何ページ読み込んだかを保存
            const currentPage = getCurrentPageNumber();
            const nextPage = nextLink ? getPageNumber(nextLink.href) : currentPage;
            sessionStorage.setItem(STORAGE_KEY_LOADED, nextPage - 1); // 次がpage/2なら、page/1まで読み込み済み
            
            console.log('[保存成功] スクロール:', scrollY, 'ページ:', nextPage - 1);
        }
    }
    
    function getCurrentPageNumber() {
        // 現在のURLからページ番号を取得（トップページは1）
        const match = location.pathname.match(/\/page\/(\d+)/);
        return match ? parseInt(match[1]) : 1;
    }
    
    function getPageNumber(url) {
        const match = url.match(/\/page\/(\d+)/);
        return match ? parseInt(match[1]) : 1;
    }
    
    window.addEventListener('beforeunload', saveScrollState);
    window.addEventListener('pagehide', saveScrollState);
    window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            saveScrollState();
        }
    });
    
    let saveInterval = setInterval(saveScrollState, 2000);

    // 復元処理
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedNextLink = sessionStorage.getItem(STORAGE_KEY_NEXT);
    const savedLoadedPage = sessionStorage.getItem(STORAGE_KEY_LOADED);
    
    console.log('[復元] 保存データ - スクロール:', savedScrollPos, '次ページ:', savedNextLink, '読み込み済みページ:', savedLoadedPage);
    
    if (savedScrollPos && parseInt(savedScrollPos) > 0 && savedLoadedPage) {
        const currentPage = getCurrentPageNumber();
        const targetPage = parseInt(savedLoadedPage);
        
        console.log('[復元] 現在ページ:', currentPage, '目標ページ:', targetPage);
        
        if (targetPage > currentPage) {
            console.log('[復元] ページ読み込みが必要');
            clearInterval(saveInterval);
            
            const waitForLoadMore = setInterval(() => {
                const main = document.querySelector('.main');
                const sentinel = document.querySelector('.infinite-scroll-sentinel');
                
                if (main && sentinel) {
                    clearInterval(waitForLoadMore);
                    console.log('[復元] 準備完了、復元開始');
                    restorePages(currentPage, targetPage, parseInt(savedScrollPos));
                }
            }, 100);
        } else {
            console.log('[復元] 追加読み込み不要、スクロールのみ');
            scrollToPosition(parseInt(savedScrollPos));
        }
    }

    function restorePages(currentPage, targetPage, targetScroll) {
        const main = document.querySelector('.main');
        const pagination = document.querySelector('.pagination');
        const currentNextLink = pagination ? pagination.querySelector('a.next') : null;
        
        console.log('[復元] 現在:', currentPage, '目標:', targetPage);
        
        if (!main || !currentNextLink) {
            console.log('[復元] 要素なし');
            scrollToPosition(targetScroll);
            return;
        }
        
        if (currentPage < targetPage) {
            const nextUrl = currentNextLink.href;
            const nextPageNum = getPageNumber(nextUrl);
            
            console.log('[復元] 読み込み:', nextUrl, 'ページ番号:', nextPageNum);
            
            fetch(nextUrl)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newPosts = doc.querySelectorAll('.post-entry');
                    console.log('[復元] 追加記事:', newPosts.length);
                    
                    newPosts.forEach(post => main.appendChild(post));
                    
                    const newNextLink = doc.querySelector('.pagination a.next');
                    if (newNextLink && currentNextLink) {
                        currentNextLink.href = newNextLink.href;
                    }
                    
                    if (nextPageNum < targetPage) {
                        setTimeout(() => restorePages(nextPageNum, targetPage, targetScroll), 100);
                    } else {
                        console.log('[復元] 目標ページ到達');
                        scrollToPosition(targetScroll);
                    }
                })
                .catch(err => {
                    console.error('[復元] エラー:', err);
                    scrollToPosition(targetScroll);
                });
        } else {
            scrollToPosition(targetScroll);
        }
    }

    function scrollToPosition(pos) {
        console.log('[復元] スクロール:', pos);
        setTimeout(() => {
            window.scrollTo(0, pos);
            sessionStorage.removeItem(STORAGE_KEY_SCROLL);
            sessionStorage.removeItem(STORAGE_KEY_NEXT);
            sessionStorage.removeItem(STORAGE_KEY_LOADED);
            console.log('[復元] 完了');
            saveInterval = setInterval(saveScrollState, 2000);
        }, 300);
    }
})();
</script>
{{- end -}}