{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyPage   = 'scroll-page-' + window.location.pathname;
        const keyCount  = 'search-count';

        // å¾©å…ƒãƒ¡ã‚¤ãƒ³å‡¦ç†
        const runRestore = async () => {
            const savedScroll = sessionStorage.getItem(keyScroll);
            const savedPage = parseInt(sessionStorage.getItem(keyPage) || "1");
            if (!savedScroll) return;

            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            const searchList = document.getElementById('mySearchResults');
            if (searchList) {
                // A. æ¤œç´¢ãƒšãƒ¼ã‚¸
                let attempts = 0;
                const checkSearch = setInterval(() => {
                    if (document.querySelectorAll('#mySearchResults li').length > 0 || attempts > 50) {
                        clearInterval(checkSearch);
                        setTimeout(() => window.scrollTo(0, parseFloat(savedScroll)), 100);
                    }
                    attempts++;
                }, 100);
            } else {
                // B. é€šå¸¸ã®ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆä¸€æ‹¬Fetchï¼‰
                if (savedPage > 1) {
                    const postContainer = document.querySelector('.main');
                    const parser = new DOMParser();
                    console.log(`ğŸ”„ å¾©å…ƒä¸­: ${savedPage}ãƒšãƒ¼ã‚¸åˆ†ã‚’ä¸€æ‹¬ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...`);

                    for (let i = 2; i <= savedPage; i++) {
                        try {
                            const res = await fetch(`${window.location.pathname}page/${i}/`);
                            if (!res.ok) break;
                            const doc = parser.parseFromString(await res.text(), 'text/html');
                            
                            // è¨˜äº‹ã‚’è¿½åŠ 
                            const newPosts = doc.querySelectorAll('.post-entry');
                            newPosts.forEach(p => postContainer.appendChild(p));

                            // ã€é‡è¦ã€‘ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã®HTMLã‚’ä¸¸ã”ã¨å·®ã—æ›¿ãˆã¦ load-more.js ã«èªè­˜ã•ã›ã‚‹
                            const oldPagination = document.querySelector('.pagination');
                            const newPagination = doc.querySelector('.pagination');
                            if (oldPagination && newPagination) {
                                oldPagination.innerHTML = newPagination.innerHTML;
                            }
                        } catch (e) { break; }
                    }
                }
                // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆå°‘ã—é•·ã‚ã«å¾…æ©Ÿã—ã¦æç”»ã‚’å®‰å®šã•ã›ã‚‹ï¼‰
                setTimeout(() => {
                    window.scrollTo({ top: parseFloat(savedScroll), behavior: 'instant' });
                    console.log("ğŸ“ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒå®Œäº†");
                }, 200);
            }
        };

        // â–  åˆ¤å®šã¨å®Ÿè¡Œ
        window.addEventListener('pageshow', (event) => {
            const nav = performance.getEntriesByType('navigation')[0];
            const isBackForward = (nav && nav.type === 'back_forward') || event.persisted;

            if (!isBackForward) {
                sessionStorage.removeItem(keyScroll);
                sessionStorage.removeItem(keyPage);
                sessionStorage.removeItem(keyCount);
            } else {
                runRestore();
            }
        });

        // â–  ä¿å­˜å‡¦ç†
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                if (window.scrollY > 100) {
                    sessionStorage.setItem(keyScroll, window.scrollY);
                    
                    // ãƒšãƒ¼ã‚¸æ•°ã®åˆ¤å®šï¼šæ¬¡ã®ãƒšãƒ¼ã‚¸ã®ç•ªå·ã‹ã‚‰ç¾åœ¨ã®ãƒšãƒ¼ã‚¸æ•°ã‚’é€†ç®—
                    const nextLink = document.querySelector('.pagination .next a');
                    if (nextLink) {
                        const match = nextLink.getAttribute('href').match(/page\/(\d+)/);
                        if (match) {
                            sessionStorage.setItem(keyPage, parseInt(match[1]) - 1);
                        }
                    } else {
                        // æ¬¡ã¸ãƒœã‚¿ãƒ³ãŒãªã„ï¼æœ€çµ‚ãƒšãƒ¼ã‚¸
                        const entries = document.querySelectorAll('.post-entry');
                        if(entries.length > 10) sessionStorage.setItem(keyPage, Math.ceil(entries.length / 10));
                    }
                }
            }, 250);
        }, { passive: true });
    })();
</script>
{{- end -}}