{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyItemIdx = 'item-idx-' + window.location.pathname;

        // --- ã‚µã‚¤ãƒˆã®è¨­å®šã«åˆã‚ã›ã¦ã“ã“ã‚’ãƒã‚§ãƒƒã‚¯ ---
        const ITEMS_PER_PAGE = 10; 
        // ------------------------------------------

        window.addEventListener('click', (e) => {
            const entry = e.target.closest('.post-entry');
            if (entry) {
                const allEntries = Array.from(document.querySelectorAll('.post-entry'));
                const idx = allEntries.indexOf(entry);
                sessionStorage.setItem(keyItemIdx, idx);
                sessionStorage.setItem(keyScroll, window.scrollY);
                console.log(`ğŸ“ ä¿å­˜: ${idx}ç•ªç›®ã®è¨˜äº‹, ${Math.floor(idx / ITEMS_PER_PAGE) + 1}ãƒšãƒ¼ã‚¸åˆ†å¿…è¦`);
            }
        });

        const restore = async () => {
            const savedIdx = parseInt(sessionStorage.getItem(keyItemIdx));
            const savedScroll = sessionStorage.getItem(keyScroll);
            if (isNaN(savedIdx)) return;

            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            // å¿…è¦ãªãƒšãƒ¼ã‚¸æ•°ã‚’ç®—å‡º (ä¾‹: 21ç•ªç›®ãªã‚‰ 21/10=2.1 -> 3ãƒšãƒ¼ã‚¸å¿…è¦)
            const neededPages = Math.floor(savedIdx / ITEMS_PER_PAGE) + 1;
            
            if (neededPages > 1) {
                const postContainer = document.querySelector('.main');
                const parser = new DOMParser();
                
                console.log(`ğŸš€ 2ãƒšãƒ¼ã‚¸ã‹ã‚‰${neededPages}ãƒšãƒ¼ã‚¸ã¾ã§ã‚’é †ç•ªã«å¾©å…ƒã—ã¾ã™...`);

                // é–“ã®ãƒšãƒ¼ã‚¸ã‚’é£›ã°ã•ãªã„ã‚ˆã†ã€ç›´åˆ—ï¼ˆawaitï¼‰ã§ç¢ºå®Ÿã«é †ç•ªã«çµåˆ
                for (let i = 2; i <= neededPages; i++) {
                    try {
                        const url = `${window.location.pathname}page/${i}/`;
                        console.log(`Fetching: ${url}`);
                        const res = await fetch(url);
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        
                        const html = await res.text();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newPosts = doc.querySelectorAll('.post-entry');
                        
                        newPosts.forEach(p => postContainer.appendChild(p));
                        
                        // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’æœ€æ–°åŒ–ï¼ˆload-more.jsç”¨ï¼‰
                        const newPagination = doc.querySelector('.pagination');
                        if (newPagination) {
                            const currentPagination = document.querySelector('.pagination');
                            if (currentPagination) currentPagination.innerHTML = newPagination.innerHTML;
                        }
                        console.log(`âœ… page/${i} çµåˆå®Œäº†`);
                    } catch (err) {
                        console.error(`âŒ page/${i} ã®å–å¾—ã«å¤±æ•—:`, err);
                        break; 
                    }
                }
            }

            setTimeout(() => {
                window.scrollTo({ top: parseFloat(savedScroll), behavior: 'instant' });
                console.log("ğŸ“ å¾©å…ƒå®Œäº†");
            }, 200);
        };

        window.addEventListener('pageshow', (e) => {
            const nav = performance.getEntriesByType('navigation')[0];
            if (e.persisted || (nav && nav.type === 'back_forward')) {
                restore();
            } else {
                sessionStorage.removeItem(keyItemIdx);
                sessionStorage.removeItem(keyScroll);
            }
        });
    })();
</script>
{{- end -}}