{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}"></script>
<script>
(function() {
    const STORAGE_KEY_SCROLL = 'infiniteScroll_pos_' + location.pathname;
    const STORAGE_KEY_NEXT = 'infiniteScroll_next_' + location.pathname;
    
    console.log('[復元] スクリプト開始');
    
    // ページ離脱時に保存（pagehideの方が確実）
    let hasUnloaded = false;
    window.addEventListener('pagehide', () => {
        if (hasUnloaded) return;
        hasUnloaded = true;
        
        const scrollY = window.scrollY;
        const nextLink = document.querySelector('.pagination a.next');
        
        console.log('[保存] スクロール位置:', scrollY);
        console.log('[保存] 次ページ:', nextLink ? nextLink.href : 'なし');
        
        if (scrollY > 0) {  // スクロールしている場合のみ保存
            sessionStorage.setItem(STORAGE_KEY_SCROLL, scrollY);
            if (nextLink) {
                sessionStorage.setItem(STORAGE_KEY_NEXT, nextLink.href);
            }
        }
    });

    // 復元処理
    const savedScrollPos = sessionStorage.getItem(STORAGE_KEY_SCROLL);
    const savedNextLink = sessionStorage.getItem(STORAGE_KEY_NEXT);
    
    console.log('[復元] 保存されたスクロール:', savedScrollPos);
    console.log('[復元] 保存された次ページ:', savedNextLink);
    
    if (savedScrollPos && parseInt(savedScrollPos) > 0 && savedNextLink) {
        console.log('[復元] 復元開始');
        
        // load-more.jsの実行を待つ
        const waitForLoadMore = setInterval(() => {
            const main = document.querySelector('.main');
            const sentinel = document.querySelector('.infinite-scroll-sentinel');
            
            if (main && sentinel) {
                clearInterval(waitForLoadMore);
                console.log('[復元] load-more.js準備完了');
                restoreState(savedNextLink, parseInt(savedScrollPos));
            }
        }, 100);
    }

    function restoreState(targetUrl, targetScroll) {
        console.log('[復元] restoreState呼び出し');
        const main = document.querySelector('.main');
        const pagination = document.querySelector('.pagination');
        let currentNextLink = pagination ? pagination.querySelector('a.next') : null;
        
        console.log('[復元] 現在URL:', currentNextLink ? currentNextLink.href : 'なし');
        console.log('[復元] 目標URL:', targetUrl);
        
        if (!main || !currentNextLink) {
            console.log('[復元] 要素なし、スクロールのみ');
            scrollToPosition(targetScroll);
            return;
        }

        if (currentNextLink.href !== targetUrl) {
            console.log('[復元] ページ読み込み:', currentNextLink.href);
            
            fetch(currentNextLink.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newPosts = doc.querySelectorAll('.post-entry');
                    console.log('[復元] 追加記事数:', newPosts.length);
                    
                    newPosts.forEach(post => main.appendChild(post));
                    
                    const newNextLink = doc.querySelector('.pagination a.next');
                    if (newNextLink && currentNextLink) {
                        currentNextLink.href = newNextLink.href;
                        console.log('[復元] nextLink更新:', newNextLink.href);
                        
                        // 少し待ってから次へ
                        setTimeout(() => restoreState(targetUrl, targetScroll), 100);
                    } else {
                        console.log('[復元] 最後のページ');
                        scrollToPosition(targetScroll);
                    }
                })
                .catch(err => {
                    console.error('[復元] エラー:', err);
                    scrollToPosition(targetScroll);
                });
        } else {
            console.log('[復元] 目標到達');
            scrollToPosition(targetScroll);
        }
    }

    function scrollToPosition(pos) {
        console.log('[復元] スクロール実行:', pos);
        setTimeout(() => {
            window.scrollTo(0, pos);
            sessionStorage.removeItem(STORAGE_KEY_SCROLL);
            sessionStorage.removeItem(STORAGE_KEY_NEXT);
            console.log('[復元] 完了、sessionStorage削除');
        }, 300);
    }
})();
</script>
{{- end -}}