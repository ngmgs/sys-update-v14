{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyPage   = 'scroll-page-' + window.location.pathname;
        const keyCount  = 'search-count';

        // ★ 追加: ブラウザバック以外のときは、保存されていた古いデータを消す
        window.addEventListener('pageshow', (event) => {
            const navEntries = performance.getEntriesByType('navigation');
            if (navEntries.length > 0) {
                const navType = navEntries[0].type;
                // 'back_forward' 以外（通常遷移やリロード）なら記憶を消去
                if (navType !== 'back_forward') {
                    sessionStorage.removeItem(keyScroll);
                    sessionStorage.removeItem(keyPage);
                    sessionStorage.removeItem(keyCount);
                }
            }
        });

        // ■ 1. 保存処理
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                if (window.scrollY > 50) {
                    sessionStorage.setItem(keyScroll, window.scrollY);
                    
                    const searchItems = document.querySelectorAll('#mySearchResults li');
                    if (searchItems.length > 0) {
                        sessionStorage.setItem(keyCount, searchItems.length);
                    } else {
                        const nextLink = document.querySelector('.pagination .next a');
                        if (nextLink) {
                            const match = nextLink.getAttribute('href').match(/page\/(\d+)/);
                            if (match) sessionStorage.setItem(keyPage, parseInt(match[1]) - 1);
                        } else {
                            const entries = document.querySelectorAll('.post-entry');
                            if(entries.length > 10) sessionStorage.setItem(keyPage, Math.ceil(entries.length / 10));
                        }
                    }
                }
            }, 150);
        }, { passive: true });

        // ■ 2. 復元処理
        const restore = async () => {
            // ここで改めて savedScroll があるか確認（pageshowで消されていればここで終わる）
            const savedScroll = sessionStorage.getItem(keyScroll);
            if (!savedScroll) return;

            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            const searchList = document.getElementById('mySearchResults');
            if (searchList) {
                let attempts = 0;
                const checkSearch = setInterval(() => {
                    if (document.querySelectorAll('#mySearchResults li').length > 0 || attempts > 50) {
                        clearInterval(checkSearch);
                        setTimeout(() => window.scrollTo(0, parseFloat(savedScroll)), 100);
                    }
                    attempts++;
                }, 100);
            } else {
                const savedPage = parseInt(sessionStorage.getItem(keyPage) || "1");
                if (savedPage > 1) {
                    const postContainer = document.querySelector('.main');
                    const parser = new DOMParser();
                    for (let i = 2; i <= savedPage; i++) {
                        try {
                            const res = await fetch(`${window.location.pathname}page/${i}/`);
                            if (!res.ok) break;
                            const doc = parser.parseFromString(await res.text(), 'text/html');
                            doc.querySelectorAll('.post-entry').forEach(p => postContainer.appendChild(p));
                        } catch (e) { break; }
                    }
                }
                setTimeout(() => window.scrollTo(0, parseFloat(savedScroll)), 150);
            }
        };

        window.addEventListener('load', restore);
    })();
</script>
{{- end -}}