{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}"></script>
<script>
(function() {
    console.log('[復元] スクリプト開始');
    
    // 保存処理
    window.addEventListener('beforeunload', () => {
        const scrollY = window.scrollY;
        const nextLink = document.querySelector('.pagination a.next');
        console.log('[保存] スクロール位置:', scrollY);
        console.log('[保存] 次ページ:', nextLink ? nextLink.href : 'なし');
        
        sessionStorage.setItem('scrollPos_' + location.pathname, scrollY);
        if (nextLink) {
            sessionStorage.setItem('nextLink_' + location.pathname, nextLink.href);
        }
    });

    // 復元処理
    const savedScrollPos = sessionStorage.getItem('scrollPos_' + location.pathname);
    const savedNextLink = sessionStorage.getItem('nextLink_' + location.pathname);
    
    console.log('[復元] 保存されたスクロール:', savedScrollPos);
    console.log('[復元] 保存された次ページ:', savedNextLink);
    
    if (savedScrollPos && savedNextLink) {
        console.log('[復元] 復元開始');
        // DOMContentLoaded後に実行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => restoreState(savedNextLink, parseInt(savedScrollPos)), 500);
            });
        } else {
            setTimeout(() => restoreState(savedNextLink, parseInt(savedScrollPos)), 500);
        }
    }

    function restoreState(targetUrl, targetScroll) {
        console.log('[復元] restoreState呼び出し', targetUrl);
        const main = document.querySelector('.main');
        const currentNextLink = document.querySelector('.pagination a.next');
        
        console.log('[復元] main要素:', main);
        console.log('[復元] 現在のnextLink:', currentNextLink);
        
        if (!main) {
            console.error('[復元] main要素が見つかりません');
            return;
        }
        
        if (!currentNextLink) {
            console.log('[復元] nextLinkなし、スクロールのみ実行');
            scrollToPosition(targetScroll);
            return;
        }

        console.log('[復元] 現在URL:', currentNextLink.href);
        console.log('[復元] 目標URL:', targetUrl);

        if (currentNextLink.href !== targetUrl) {
            console.log('[復元] ページ読み込み開始:', currentNextLink.href);
            fetch(currentNextLink.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newPosts = doc.querySelectorAll('.post-entry');
                    console.log('[復元] 追加する記事数:', newPosts.length);
                    newPosts.forEach(post => main.appendChild(post));
                    
                    const newNextLink = doc.querySelector('.pagination a.next');
                    if (newNextLink) {
                        const pagination = document.querySelector('.pagination');
                        if (pagination) {
                            const oldNext = pagination.querySelector('a.next');
                            if (oldNext) {
                                oldNext.href = newNextLink.href;
                                console.log('[復元] nextLink更新:', newNextLink.href);
                            }
                        }
                        restoreState(targetUrl, targetScroll);
                    } else {
                        console.log('[復元] これ以上ページなし');
                        scrollToPosition(targetScroll);
                    }
                })
                .catch(err => {
                    console.error('[復元] fetch失敗:', err);
                });
        } else {
            console.log('[復元] 目標URL到達、スクロール実行');
            scrollToPosition(targetScroll);
        }
    }

    function scrollToPosition(pos) {
        console.log('[復元] スクロール位置設定:', pos);
        setTimeout(() => {
            window.scrollTo(0, pos);
            sessionStorage.removeItem('scrollPos_' + location.pathname);
            sessionStorage.removeItem('nextLink_' + location.pathname);
            console.log('[復元] 完了');
        }, 100);
    }
})();
</script>
{{- end -}}