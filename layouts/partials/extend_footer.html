{{- if .IsNode -}}
<script src="{{ "js/load-more.js" | absURL }}" defer></script>

<script>
    (function() {
        const keyScroll = 'scroll-pos-' + window.location.pathname;
        const keyItemIdx = 'item-idx-' + window.location.pathname; // è³¢ã„ãƒã‚¤ãƒ³ãƒˆï¼šä½•ç•ªç›®ã®è¨˜äº‹ã‹

        // â–  1. ä¿å­˜å‡¦ç†ï¼ˆè¨˜äº‹ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã€Œä½•ç•ªç›®ã‹ã€ã‚’è¨˜éŒ²ï¼‰
        window.addEventListener('click', (e) => {
            const entry = e.target.closest('.post-entry');
            if (entry) {
                const allEntries = Array.from(document.querySelectorAll('.post-entry'));
                const idx = allEntries.indexOf(entry);
                sessionStorage.setItem(keyItemIdx, idx);
                sessionStorage.setItem(keyScroll, window.scrollY);
            }
        });

        // â–  2. å¾©å…ƒå‡¦ç†
        const restore = async () => {
            const savedIdx = parseInt(sessionStorage.getItem(keyItemIdx));
            const savedScroll = sessionStorage.getItem(keyScroll);
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯åˆ¤å®šï¼ˆå‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶™ç¶šï¼‰
            const nav = performance.getEntriesByType('navigation')[0];
            const isBackForward = (nav && nav.type === 'back_forward');
            if (!isBackForward || isNaN(savedIdx)) {
                // é€šå¸¸é·ç§»ãªã‚‰ã‚´ãƒŸã‚’æ¶ˆã—ã¦çµ‚äº†
                ['scroll-pos-', 'item-idx-'].forEach(k => sessionStorage.removeItem(k + window.location.pathname));
                return;
            }

            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            // å¿…è¦ãªãƒšãƒ¼ã‚¸æ•°ã‚’è¨ˆç®—ï¼ˆ1ãƒšãƒ¼ã‚¸10ä»¶æƒ³å®šï¼‰
            const neededPages = Math.floor(savedIdx / 10) + 1;
            
            if (neededPages > 1) {
                const postContainer = document.querySelector('.main');
                const parser = new DOMParser();
                
                // è³¢ã„ãƒã‚¤ãƒ³ãƒˆï¼šPromise.all ã§å…¨ãƒšãƒ¼ã‚¸ã‚’ã€ŒåŒæ™‚ä¸¦åˆ—ã€ã§Fetchï¼ˆè¶…é«˜é€Ÿï¼‰
                const requests = [];
                for (let i = 2; i <= neededPages; i++) {
                    requests.push(fetch(`${window.location.pathname}page/${i}/`).then(r => r.text()));
                }

                console.log(`ğŸš€ ${neededPages}ãƒšãƒ¼ã‚¸åˆ†ã‚’ä¸¦åˆ—ãƒ­ãƒ¼ãƒ‰ä¸­...`);
                const htmls = await Promise.all(requests);

                htmls.forEach(html => {
                    const doc = parser.parseFromString(html, 'text/html');
                    doc.querySelectorAll('.post-entry').forEach(p => postContainer.appendChild(p));
                    
                    // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚‚å¸¸ã«æœ€æ–°ã«æ›´æ–°
                    const newPagination = doc.querySelector('.pagination');
                    if (newPagination) document.querySelector('.pagination').innerHTML = newPagination.innerHTML;
                });
            }

            // æç”»å®Œäº†ã‚’å¾…ã£ã¦ã‚¸ãƒ£ãƒ³ãƒ—
            setTimeout(() => {
                window.scrollTo({ top: parseFloat(savedScroll), behavior: 'instant' });
            }, 100);
        };

        window.addEventListener('pageshow', (e) => {
            if (e.persisted || performance.getEntriesByType('navigation')[0]?.type === 'back_forward') {
                restore();
            }
        });
    })();
</script>
{{- end -}}